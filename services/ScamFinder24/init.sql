CREATE DATABASE IF NOT EXISTS myDB;

USE myDB;

CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  creation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_name (username)
);

CREATE TABLE IF NOT EXISTS posts (
  username VARCHAR(50) NOT NULL,
  public BOOL NOT NULL,
  post_id INT AUTO_INCREMENT PRIMARY KEY,
  latitude FLOAT NOT NULL,
  longitude FLOAT NOT NULL,
  creation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  description VARCHAR(500) DEFAULT NULL,
  descriptor VARCHAR(255) DEFAULT NULL,
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS secretPosts (
  username VARCHAR(50) DEFAULT NULL,
  post_id INT AUTO_INCREMENT PRIMARY KEY,
  location VARCHAR(50) NOT NULL,
  creation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  description VARCHAR(500) DEFAULT NULL,
  descriptor VARCHAR(255) DEFAULT NULL
);

CREATE TABLE IF NOT EXISTS comments (
  username VARCHAR(50) NOT NULL,
  comment_id INT AUTO_INCREMENT PRIMARY KEY,
  post_id INT NOT NULL,
  comment VARCHAR(500) NOT NULL,
  creation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_post_id (post_id),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
  FOREIGN KEY (post_id) REFERENCES posts(post_id)
);

SET GLOBAL event_scheduler = ON;




CREATE EVENT IF NOT EXISTS delete_old_secretposts
ON SCHEDULE EVERY 10 MINUTE
DO DELETE FROM secretPosts
WHERE creation_time < NOW() - INTERVAL 10 MINUTE;


CREATE EVENT IF NOT EXISTS delete_old_users
ON SCHEDULE EVERY 10 MINUTE
DO DELETE FROM users
WHERE creation_time < NOW() - INTERVAL 10 MINUTE;